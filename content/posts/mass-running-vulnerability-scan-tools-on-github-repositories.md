+++
title = 'Mass Running Vulnerability Scan Tools on Github Repositories'
date = 2023-11-19T09:21:51-06:00
draft = true
+++

# vuln scanning github repos
I decided to run code vulnerability scanning tools en mass on all of the PHP github repositories that have a certain amount of stars/followers.
It helped that i already started with a list of github repositories. That seems like a major limiting factor for this project.
I sorted the repositories by number of stars so the most interesting ones get scanned, and I scanned the top 30k.
I had intended to scan more, but I ended up aborting the scans early because snyk contacted me and complained that i was overloading their servers

## why
I did not expect the tools to point me right to bugs immediately.
It is more like the outputs of the tools will serve as an entrypoint for browsing potential bugs.

## browsing the outputs is fun
Then, I created some simple terminal tools to browse the script outputs, clone, and investigate anything interesting.
I used `fzf` with a custom preview program to create interactive text user interfaces.
When a repository is selected, the scripts will automatically clone it and pull up the report for that repository in `vim`.

When I'm busy watching my kids or waiting for something, I can pull out a laptop and just poke around at random sections of other people's code and write down anything interesting.
It is kind of an engaging hobby. It requires some amount of focus to actually try out any bugs, but it is very easy to browse around while other things are happening.
I have been keeping track of a list of bugs that I have found. So far, I have only found a few things worth reporting or investigating in some small repositories.
I will talk a little more about what kinds of bugs I have found later in this post.

## analyzing quantities of repositories
- checking the data to see how many repos there are with a given number of stars.
  - there are 780 repositories that have over a thousand stars!
  ```bash
  $ zcat repos-with-interest.gz | awk '$4 == "PHP" && $2 > 1000' | wc -l
  780
  ```
- figuring out how many are reasonable to scan
  - i intended to scan every repository with more than 5 stars.
```bash
$ zcat repos-with-interest.gz | awk '$4 == "PHP" && $2 > 10' | wc -l
41335
$ zcat repos-with-interest.gz | awk '$4 == "PHP" && $2 > 5' | wc -l
68411
```

## procedure for scanning
- start a docker container
- entrypoint script connects to rabbitmq to get a request.
  - in retrospect, i would not use rabbitmq. i would just make a plain queue API because rabbitmq might consider requests as failed if they take too long.
  - i created a [queue API](https://github.com/nicholas-long/environment/blob/main/zet/20231024041243/README.md) do to this in the future

## what tools to run
- [snyk](https://snyk.io/)
  - this code scanner is very good.
  - it has a few false positives, but it can also analyze and explain the origin of vulnerable user data 
- php code sniffer with [security audit vulnerability scanning extensions](https://github.com/FloeDesignTechnologies/phpcs-security-audit)
  - ended up not using the output from phpcs very much
  - looks like it could be useful to analyze with scripts

## dockerfile for scan worker
```dockerfile
FROM kalilinux/kali-rolling
WORKDIR /secaudit

RUN apt-get update && apt-get install -y \
  git \
  php-codesniffer \
  amqp-tools \
  npm

RUN npm install snyk -g
RUN git clone https://github.com/FloeDesignTechnologies/phpcs-security-audit

ADD entrypoint .
ADD scan-worker .

ENTRYPOINT [ "/secaudit/entrypoint" ]
```

# what kinds of bugs have been found so far
- no specifics
